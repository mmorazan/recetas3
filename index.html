<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Recetas - GCode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .main-content {
            padding: 20px;
        }
        .active-tab {
            background-color: #0d6efd;
            color: white !important;
        }
        .ingredient-item {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <h4 class="text-center mb-4">Gestión de Recetas</h4>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active-tab" href="#" data-target="recetas">Recetas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="ingredientes">Ingredientes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="categorias">Categorías</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="menus">Menús</a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Recetas Section -->
                <div id="recetas" class="form-section active">
                    <h2>Gestión de Recetas</h2>
                    <div class="row mb-3">
                        <div class="col">
                            <button class="btn btn-primary" id="add-recipe-btn">Agregar Nueva Receta</button>
                        </div>
                    </div>
                    
                    <!-- Recipe List -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="recipes-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Menú</th>
                                    <th>Precio Venta</th>
                                    <th>Costo Total</th>
                                    <th>Porciones</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Recipes will be loaded here via AJAX -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Recipe Form (hidden by default) -->
                    <div id="recipe-form-container" style="display: none;">
                        <h3 id="recipe-form-title">Nueva Receta</h3>
                        <form id="recipe-form">
                            <input type="hidden" id="recipe-id">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="recipe-name" class="form-label">Nombre de la Receta</label>
                                    <input type="text" class="form-control" id="recipe-name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="recipe-menu" class="form-label">Menú</label>
                                    <select class="form-select" id="recipe-menu" required>
                                        <!-- Menu options will be loaded via AJAX -->
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="recipe-price" class="form-label">Precio de Venta</label>
                                    <input type="number" step="0.01" class="form-control" id="recipe-price" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="recipe-portions" class="form-label">Porciones</label>
                                    <input type="number" class="form-control" id="recipe-portions" value="1" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="recipe-time" class="form-label">Tiempo Preparación (min)</label>
                                    <input type="number" class="form-control" id="recipe-time">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="recipe-instructions" class="form-label">Instrucciones</label>
                                <textarea class="form-control" id="recipe-instructions" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="recipe-image" class="form-label">Imagen</label>
                                <input type="file" class="form-control" id="recipe-image">
                            </div>
                            
                            <h4 class="mt-4">Ingredientes</h4>
                            <div id="ingredients-container">
                                <!-- Ingredient items will be added here -->
                            </div>
                            
                            <button type="button" class="btn btn-secondary mt-2" id="add-ingredient-btn">
                                Agregar Ingrediente
                            </button>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">Guardar Receta</button>
                                <button type="button" class="btn btn-secondary" id="cancel-recipe-btn">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Ingredientes Section -->
                <div id="ingredientes" class="form-section">
                    <h2>Gestión de Ingredientes</h2>
                    <div class="row mb-3">
                        <div class="col">
                            <button class="btn btn-primary" id="add-ingredient-btn-main">Agregar Nuevo Ingrediente</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="ingredients-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Categoría</th>
                                    <th>Presentación</th>
                                    <th>Precio Compra</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Ingredients will be loaded here via AJAX -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Ingredient Form (hidden by default) -->
                    <div id="ingredient-form-container" style="display: none;">
                        <h3 id="ingredient-form-title">Nuevo Ingrediente</h3>
                        <form id="ingredient-form">
                            <input type="hidden" id="ingredient-id">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="ingredient-name" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="ingredient-name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="ingredient-category" class="form-label">Categoría</label>
                                    <select class="form-select" id="ingredient-category" required>
                                        <!-- Category options will be loaded via AJAX -->
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="ingredient-presentation" class="form-label">Presentación</label>
                                    <select class="form-select" id="ingredient-presentation" required>
                                        <option value="Libra">Libra</option>
                                        <option value="Unidad">Unidad</option>
                                        <option value="Gramos">Gramos</option>
                                        <option value="Onza">Onza</option>
                                        <option value="Kilogramo">Kilogramo</option>
                                        <option value="Litro">Litro</option>
                                        <option value="Mililitro">Mililitro</option>
                                        <option value="Cucharada">Cucharada</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="ingredient-price" class="form-label">Precio de Compra</label>
                                    <input type="number" step="0.01" class="form-control" id="ingredient-price" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="ingredient-weight" class="form-label">Peso Unitario (gramos)</label>
                                    <input type="number" step="0.01" class="form-control" id="ingredient-weight">
                                    <small class="text-muted">Solo si la presentación es por Unidad</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="ingredient-description" class="form-label">Descripción</label>
                                <textarea class="form-control" id="ingredient-description" rows="3"></textarea>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">Guardar Ingrediente</button>
                                <button type="button" class="btn btn-secondary" id="cancel-ingredient-btn">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Categorías Section -->
                <div id="categorias" class="form-section">
                    <h2>Gestión de Categorías</h2>
                    <div class="row mb-3">
                        <div class="col">
                            <button class="btn btn-primary" id="add-category-btn">Agregar Nueva Categoría</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="categories-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Categories will be loaded here via AJAX -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Category Form (hidden by default) -->
                    <div id="category-form-container" style="display: none;">
                        <h3 id="category-form-title">Nueva Categoría</h3>
                        <form id="category-form">
                            <input type="hidden" id="category-id">
                            <div class="mb-3">
                                <label for="category-name" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="category-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="category-description" class="form-label">Descripción</label>
                                <textarea class="form-control" id="category-description" rows="3"></textarea>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">Guardar Categoría</button>
                                <button type="button" class="btn btn-secondary" id="cancel-category-btn">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Menús Section -->
                <div id="menus" class="form-section">
                    <h2>Gestión de Menús</h2>
                    <div class="row mb-3">
                        <div class="col">
                            <button class="btn btn-primary" id="add-menu-btn">Agregar Nuevo Menú</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="menus-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Menus will be loaded here via AJAX -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Menu Form (hidden by default) -->
                    <div id="menu-form-container" style="display: none;">
                        <h3 id="menu-form-title">Nuevo Menú</h3>
                        <form id="menu-form">
                            <input type="hidden" id="menu-id">
                            <div class="mb-3">
                                <label for="menu-name" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="menu-name" required>
                            </div>
                            
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">Guardar Menú</button>
                                <button type="button" class="btn btn-secondary" id="cancel-menu-btn">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredient Item Template (hidden) -->
    <div id="ingredient-item-template" style="display: none;">
        <div class="ingredient-item">
            <input type="hidden" class="recipe-ingredient-id">
            <div class="row">
                <div class="col-md-5">
                    <label class="form-label">Ingrediente</label>
                    <select class="form-select ingredient-select" required>
                        <!-- Ingredient options will be loaded via AJAX -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Cantidad</label>
                    <input type="number" step="0.001" class="form-control ingredient-quantity" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Merma (%)</label>
                    <input type="number" step="0.01" class="form-control ingredient-waste" value="0.00">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger remove-ingredient-btn">X</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Navigation between sections
            $('.nav-link').click(function(e) {
                e.preventDefault();
                $('.nav-link').removeClass('active-tab');
                $(this).addClass('active-tab');
                
                const target = $(this).data('target');
                $('.form-section').removeClass('active');
                $('#' + target).addClass('active');
                
                // Load data for the selected section
                switch(target) {
                    case 'recetas':
                        loadRecipes();
                        break;
                    case 'ingredientes':
                        loadIngredients();
                        break;
                    case 'categorias':
                        loadCategories();
                        break;
                    case 'menus':
                        loadMenus();
                        break;
                }
            });
            
            // Load initial data
            loadRecipes();
            loadIngredients();
            loadCategories();
            loadMenus();
            
            // Recipe management
            $('#add-recipe-btn').click(function() {
                $('#recipe-form-title').text('Nueva Receta');
                $('#recipe-id').val('');
                $('#recipe-form')[0].reset();
                $('#ingredients-container').empty();
                $('#recipe-form-container').show();
                loadMenuOptions();
                loadIngredientOptions();
            });
            
            $('#cancel-recipe-btn').click(function() {
                $('#recipe-form-container').hide();
            });
            
            $('#recipe-form').submit(function(e) {
                e.preventDefault();
                saveRecipe();
            });
            
            $('#add-ingredient-btn').click(function() {
                addIngredientItem();
            });
            
            // Ingredient management (main section)
            $('#add-ingredient-btn-main').click(function() {
                $('#ingredient-form-title').text('Nuevo Ingrediente');
                $('#ingredient-id').val('');
                $('#ingredient-form')[0].reset();
                $('#ingredient-form-container').show();
                loadCategoryOptions();
            });
            
            $('#cancel-ingredient-btn').click(function() {
                $('#ingredient-form-container').hide();
            });
            
            $('#ingredient-form').submit(function(e) {
                e.preventDefault();
                saveIngredient();
            });
            
            // Category management
            $('#add-category-btn').click(function() {
                $('#category-form-title').text('Nueva Categoría');
                $('#category-id').val('');
                $('#category-form')[0].reset();
                $('#category-form-container').show();
            });
            
            $('#cancel-category-btn').click(function() {
                $('#category-form-container').hide();
            });
            
            $('#category-form').submit(function(e) {
                e.preventDefault();
                saveCategory();
            });
            
            // Menu management
            $('#add-menu-btn').click(function() {
                $('#menu-form-title').text('Nuevo Menú');
                $('#menu-id').val('');
                $('#menu-form')[0].reset();
                $('#menu-form-container').show();
            });
            
            $('#cancel-menu-btn').click(function() {
                $('#menu-form-container').hide();
            });
            
            $('#menu-form').submit(function(e) {
                e.preventDefault();
                saveMenu();
            });
        });
        
        // Function to add ingredient item to recipe form
        function addIngredientItem(ingredientId = '', quantity = '', waste = '0.00') {
            const template = $('#ingredient-item-template').html();
            const $newItem = $(template);
            
            // Set values if provided
            if (ingredientId) {
                $newItem.find('.ingredient-select').val(ingredientId);
            }
            if (quantity) {
                $newItem.find('.ingredient-quantity').val(quantity);
            }
            $newItem.find('.ingredient-waste').val(waste);
            
            // Load ingredient options
            loadIngredientOptions($newItem.find('.ingredient-select'));
            
            // Add remove button functionality
            $newItem.find('.remove-ingredient-btn').click(function() {
                $(this).closest('.ingredient-item').remove();
            });
            
            $('#ingredients-container').append($newItem);
        }
        
        // Function to load recipes
        function loadRecipes() {
            $.ajax({
                url: 'api/recipes.php?action=list',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const $tbody = $('#recipes-table tbody');
                    $tbody.empty();
                    
                    response.forEach(recipe => {
                        $tbody.append(`
                            <tr>
                                <td>${recipe.id}</td>
                                <td>${recipe.nombre}</td>
                                <td>${recipe.menu_name || '-'}</td>
                                <td>$${recipe.precio_venta.toFixed(2)}</td>
                                <td>$${recipe.costo_total.toFixed(2)}</td>
                                <td>${recipe.porciones}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-recipe-btn" data-id="${recipe.id}">Editar</button>
                                    <button class="btn btn-sm btn-danger delete-recipe-btn" data-id="${recipe.id}">Eliminar</button>
                                </td>
                            </tr>
                        `);
                    });
                    
                    // Add event listeners for edit buttons
                    $('.edit-recipe-btn').click(function() {
                        const recipeId = $(this).data('id');
                        editRecipe(recipeId);
                    });
                    
                    // Add event listeners for delete buttons
                    $('.delete-recipe-btn').click(function() {
                        const recipeId = $(this).data('id');
                        if (confirm('¿Estás seguro de que deseas eliminar esta receta?')) {
                            deleteRecipe(recipeId);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading recipes:', error);
                    alert('Error al cargar las recetas');
                }
            });
        }
        
        // Function to load ingredients
        function loadIngredients() {
            $.ajax({
                url: 'api/ingredients.php?action=list',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const $tbody = $('#ingredients-table tbody');
                    $tbody.empty();
                    
                    response.forEach(ingredient => {
                        $tbody.append(`
                            <tr>
                                <td>${ingredient.id}</td>
                                <td>${ingredient.nombre}</td>
                                <td>${ingredient.categoria_name}</td>
                                <td>${ingredient.presentacion}</td>
                                <td>$${ingredient.precio_compra.toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-ingredient-btn" data-id="${ingredient.id}">Editar</button>
                                    <button class="btn btn-sm btn-danger delete-ingredient-btn" data-id="${ingredient.id}">Eliminar</button>
                                </td>
                            </tr>
                        `);
                    });
                    
                    // Add event listeners for edit buttons
                    $('.edit-ingredient-btn').click(function() {
                        const ingredientId = $(this).data('id');
                        editIngredient(ingredientId);
                    });
                    
                    // Add event listeners for delete buttons
                    $('.delete-ingredient-btn').click(function() {
                        const ingredientId = $(this).data('id');
                        if (confirm('¿Estás seguro de que deseas eliminar este ingrediente?')) {
                            deleteIngredient(ingredientId);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading ingredients:', error);
                    alert('Error al cargar los ingredientes');
                }
            });
        }
        
        // Function to load categories
        function loadCategories() {
            $.ajax({
                url: 'api/categories.php?action=list',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const $tbody = $('#categories-table tbody');
                    $tbody.empty();
                    
                    response.forEach(category => {
                        $tbody.append(`
                            <tr>
                                <td>${category.id}</td>
                                <td>${category.nombre}</td>
                                <td>${category.descripcion || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-category-btn" data-id="${category.id}">Editar</button>
                                    <button class="btn btn-sm btn-danger delete-category-btn" data-id="${category.id}">Eliminar</button>
                                </td>
                            </tr>
                        `);
                    });
                    
                    // Add event listeners for edit buttons
                    $('.edit-category-btn').click(function() {
                        const categoryId = $(this).data('id');
                        editCategory(categoryId);
                    });
                    
                    // Add event listeners for delete buttons
                    $('.delete-category-btn').click(function() {
                        const categoryId = $(this).data('id');
                        if (confirm('¿Estás seguro de que deseas eliminar esta categoría?')) {
                            deleteCategory(categoryId);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading categories:', error);
                    alert('Error al cargar las categorías');
                }
            });
        }
        
        // Function to load menus
        function loadMenus() {
            $.ajax({
                url: 'api/menus.php?action=list',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const $tbody = $('#menus-table tbody');
                    $tbody.empty();
                    
                    response.forEach(menu => {
                        $tbody.append(`
                            <tr>
                                <td>${menu.id}</td>
                                <td>${menu.nombre}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-menu-btn" data-id="${menu.id}">Editar</button>
                                    <button class="btn btn-sm btn-danger delete-menu-btn" data-id="${menu.id}">Eliminar</button>
                                </td>
                            </tr>
                        `);
                    });
                    
                    // Add event listeners for edit buttons
                    $('.edit-menu-btn').click(function() {
                        const menuId = $(this).data('id');
                        editMenu(menuId);
                    });
                    
                    // Add event listeners for delete buttons
                    $('.delete-menu-btn').click(function() {
                        const menuId = $(this).data('id');
                        if (confirm('¿Estás seguro de que deseas eliminar este menú?')) {
                            deleteMenu(menuId);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading menus:', error);
                    alert('Error al cargar los menús');
                }
            });
        }
        
        // Function to load menu options for recipe form
        function loadMenuOptions() {
            $.ajax({
                url: 'api/menus.php?action=list',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const $select = $('#recipe-menu');
                    $select.empty();
                    
                    response.forEach(menu => {
                        $select.append(`<option value="${menu.id}">${menu.nombre}</option>`);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading menu options:', error);
                }
            });
        }
        
        // Function to load category options for ingredient form
        function loadCategoryOptions() {
            $.ajax({
                url: 'api/categories.php?action=list',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const $select = $('#ingredient-category');
                    $select.empty();
                    
                    response.forEach(category => {
                        $select.append(`<option value="${category.id}">${category.nombre}</option>`);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading category options:', error);
                }
            });
        }
        
        // Function to load ingredient options for recipe form
        function loadIngredientOptions($selectElement = null) {
            $.ajax({
                url: 'api/ingredients.php?action=list',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    const $select = $selectElement || $('.ingredient-select').last();
                    $select.empty();
                    $select.append('<option value="">Seleccione un ingrediente</option>');
                    
                    response.forEach(ingredient => {
                        $select.append(`<option value="${ingredient.id}">${ingredient.nombre} (${ingredient.presentacion})</option>`);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading ingredient options:', error);
                }
            });
        }
        
        // Function to edit recipe
        function editRecipe(recipeId) {
            $.ajax({
                url: `api/recipes.php?action=get&id=${recipeId}`,
                method: 'GET',
                dataType: 'json',
                success: function(recipe) {
                    $('#recipe-form-title').text('Editar Receta');
                    $('#recipe-id').val(recipe.id);
                    $('#recipe-name').val(recipe.nombre);
                    $('#recipe-menu').val(recipe.menu_id);
                    $('#recipe-price').val(recipe.precio_venta);
                    $('#recipe-portions').val(recipe.porciones);
                    $('#recipe-time').val(recipe.tiempo_preparacion);
                    $('#recipe-instructions').val(recipe.instrucciones);
                    
                    // Load menu options
                    loadMenuOptions();
                    
                    // Clear and add ingredients
                    $('#ingredients-container').empty();
                    
                    // Load recipe ingredients
                    $.ajax({
                        url: `api/recipe_ingredients.php?action=list&recipe_id=${recipeId}`,
                        method: 'GET',
                        dataType: 'json',
                        success: function(ingredients) {
                            ingredients.forEach(ingredient => {
                                addIngredientItem(
                                    ingredient.ingrediente_id,
                                    ingredient.cantidad,
                                    ingredient.porcentaje_merma
                                );
                            });
                            
                            // Show the form
                            $('#recipe-form-container').show();
                        },
                        error: function(xhr, status, error) {
                            console.error('Error loading recipe ingredients:', error);
                            alert('Error al cargar los ingredientes de la receta');
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading recipe:', error);
                    alert('Error al cargar la receta');
                }
            });
        }
        
        // Function to save recipe
        function saveRecipe() {
            const recipeId = $('#recipe-id').val();
            const action = recipeId ? 'update' : 'create';
            
            // Get all ingredients
            const ingredients = [];
            $('.ingredient-item').each(function() {
                ingredients.push({
                    ingrediente_id: $(this).find('.ingredient-select').val(),
                    cantidad: $(this).find('.ingredient-quantity').val(),
                    porcentaje_merma: $(this).find('.ingredient-waste').val()
                });
            });
            
            // Validate at least one ingredient
            if (ingredients.length === 0) {
                alert('Debe agregar al menos un ingrediente');
                return;
            }
            
            // Create FormData to handle file upload
            const formData = new FormData();
            formData.append('action', action);
            formData.append('id', recipeId);
            formData.append('nombre', $('#recipe-name').val());
            formData.append('menu_id', $('#recipe-menu').val());
            formData.append('precio_venta', $('#recipe-price').val());
            formData.append('porciones', $('#recipe-portions').val());
            formData.append('tiempo_preparacion', $('#recipe-time').val());
            formData.append('instrucciones', $('#recipe-instructions').val());
            formData.append('ingredients', JSON.stringify(ingredients));
            
            // Add image file if selected
            const imageFile = $('#recipe-image')[0].files[0];
            if (imageFile) {
                formData.append('imagen', imageFile);
            }
            
            $.ajax({
                url: 'api/recipes.php',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Receta guardada correctamente');
                        $('#recipe-form-container').hide();
                        loadRecipes();
                    } else {
                        alert('Error al guardar la receta: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error saving recipe:', error);
                    alert('Error al guardar la receta');
                }
            });
        }
        
        // Function to delete recipe
        function deleteRecipe(recipeId) {
            $.ajax({
                url: 'api/recipes.php',
                method: 'POST',
                data: {
                    action: 'delete',
                    id: recipeId
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Receta eliminada correctamente');
                        loadRecipes();
                    } else {
                        alert('Error al eliminar la receta: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting recipe:', error);
                    alert('Error al eliminar la receta');
                }
            });
        }
        
        // Function to edit ingredient
        function editIngredient(ingredientId) {
            $.ajax({
                url: `api/ingredients.php?action=get&id=${ingredientId}`,
                method: 'GET',
                dataType: 'json',
                success: function(ingredient) {
                    $('#ingredient-form-title').text('Editar Ingrediente');
                    $('#ingredient-id').val(ingredient.id);
                    $('#ingredient-name').val(ingredient.nombre);
                    $('#ingredient-category').val(ingredient.categoria_id);
                    $('#ingredient-presentation').val(ingredient.presentacion);
                    $('#ingredient-price').val(ingredient.precio_compra);
                    $('#ingredient-weight').val(ingredient.peso_unitario);
                    $('#ingredient-description').val(ingredient.descripcion);
                    
                    // Load category options
                    loadCategoryOptions();
                    
                    // Show the form
                    $('#ingredient-form-container').show();
                },
                error: function(xhr, status, error) {
                    console.error('Error loading ingredient:', error);
                    alert('Error al cargar el ingrediente');
                }
            });
        }
        
        // Function to save ingredient
        function saveIngredient() {
            const ingredientId = $('#ingredient-id').val();
            const action = ingredientId ? 'update' : 'create';
            
            $.ajax({
                url: 'api/ingredients.php',
                method: 'POST',
                data: {
                    action: action,
                    id: ingredientId,
                    nombre: $('#ingredient-name').val(),
                    categoria_id: $('#ingredient-category').val(),
                    presentacion: $('#ingredient-presentation').val(),
                    precio_compra: $('#ingredient-price').val(),
                    peso_unitario: $('#ingredient-weight').val(),
                    descripcion: $('#ingredient-description').val()
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Ingrediente guardado correctamente');
                        $('#ingredient-form-container').hide();
                        loadIngredients();
                    } else {
                        alert('Error al guardar el ingrediente: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error saving ingredient:', error);
                    alert('Error al guardar el ingrediente');
                }
            });
        }
        
        // Function to delete ingredient
        function deleteIngredient(ingredientId) {
            $.ajax({
                url: 'api/ingredients.php',
                method: 'POST',
                data: {
                    action: 'delete',
                    id: ingredientId
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Ingrediente eliminado correctamente');
                        loadIngredients();
                    } else {
                        alert('Error al eliminar el ingrediente: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting ingredient:', error);
                    alert('Error al eliminar el ingrediente');
                }
            });
        }
        
        // Function to edit category
        function editCategory(categoryId) {
            $.ajax({
                url: `api/categories.php?action=get&id=${categoryId}`,
                method: 'GET',
                dataType: 'json',
                success: function(category) {
                    $('#category-form-title').text('Editar Categoría');
                    $('#category-id').val(category.id);
                    $('#category-name').val(category.nombre);
                    $('#category-description').val(category.descripcion);
                    
                    // Show the form
                    $('#category-form-container').show();
                },
                error: function(xhr, status, error) {
                    console.error('Error loading category:', error);
                    alert('Error al cargar la categoría');
                }
            });
        }
        
        // Function to save category
        function saveCategory() {
            const categoryId = $('#category-id').val();
            const action = categoryId ? 'update' : 'create';
            
            $.ajax({
                url: 'api/categories.php',
                method: 'POST',
                data: {
                    action: action,
                    id: categoryId,
                    nombre: $('#category-name').val(),
                    descripcion: $('#category-description').val()
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Categoría guardada correctamente');
                        $('#category-form-container').hide();
                        loadCategories();
                    } else {
                        alert('Error al guardar la categoría: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error saving category:', error);
                    alert('Error al guardar la categoría');
                }
            });
        }
        
        // Function to delete category
        function deleteCategory(categoryId) {
            $.ajax({
                url: 'api/categories.php',
                method: 'POST',
                data: {
                    action: 'delete',
                    id: categoryId
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Categoría eliminada correctamente');
                        loadCategories();
                    } else {
                        alert('Error al eliminar la categoría: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting category:', error);
                    alert('Error al eliminar la categoría');
                }
            });
        }
        
        // Function to edit menu
        function editMenu(menuId) {
            $.ajax({
                url: `api/menus.php?action=get&id=${menuId}`,
                method: 'GET',
                dataType: 'json',
                success: function(menu) {
                    $('#menu-form-title').text('Editar Menú');
                    $('#menu-id').val(menu.id);
                    $('#menu-name').val(menu.nombre);
                    
                    // Show the form
                    $('#menu-form-container').show();
                },
                error: function(xhr, status, error) {
                    console.error('Error loading menu:', error);
                    alert('Error al cargar el menú');
                }
            });
        }
        
        // Function to save menu
        function saveMenu() {
            const menuId = $('#menu-id').val();
            const action = menuId ? 'update' : 'create';
            
            $.ajax({
                url: 'api/menus.php',
                method: 'POST',
                data: {
                    action: action,
                    id: menuId,
                    nombre: $('#menu-name').val()
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Menú guardado correctamente');
                        $('#menu-form-container').hide();
                        loadMenus();
                    } else {
                        alert('Error al guardar el menú: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error saving menu:', error);
                    alert('Error al guardar el menú');
                }
            });
        }
        
        // Function to delete menu
        function deleteMenu(menuId) {
            $.ajax({
                url: 'api/menus.php',
                method: 'POST',
                data: {
                    action: 'delete',
                    id: menuId
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Menú eliminado correctamente');
                        loadMenus();
                    } else {
                        alert('Error al eliminar el menú: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting menu:', error);
                    alert('Error al eliminar el menú');
                }
            });
        }
    </script>
</body>
</html>